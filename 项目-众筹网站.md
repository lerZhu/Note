# 环境搭建

## 1、环境搭建总体目标![image-20210508163819844](C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210508163819844.png)

## 2、创建工程

### 2.1、项目架构图

![image-20210508163931115](C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210508163931115.png)

### 2.2、工程创建计划

idea版

- **atcrowdfunding**

  - **atcrowdfunding01-admin-parent**

    groupId：com.atguigu.crowd

    artifactId：atcrowdfunding01-admin-parent

    packaging：**pom**

    - **atcrowdfunding02-admin-webui**

      groupId：com.atguigu.crowd

      artifactId：atcrowdfunding02-admin-webui

      packaging：**war**

    - **atcrowdfunding03-admin-component**

      groupId：com.atguigu.crowd

      artifactId：atcrowdfunding03-admin-component

      packaging：**jar**

    - **atcrowdfunding04-admin-entity**

      groupId：com.atguigu.crowd

      artifactId：atcrowdfunding04-admin-entity

      packaging：**jar**

  - **atcrowdfunding05-common-util**

    groupId：com.atguigu.crowd

    artifactId：atcrowdfunding05-common-util

    packaging：**jar**

  - **atcrowdfunding06-common-reverse**

    groupId：com.atguigu.crowd

    artifactId：atcrowdfunding06-common-reverse

    packaging：**jar**

### 2.3、 Maven 工程和 Maven 模块

![image-20210508164612798](C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210508164612798.png)

### 2.4、建立依赖关系

![image-20210508164720624](C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210508164720624.png)

```xml
<dependencies>
    <dependency>
        <groupId>org.example</groupId>
        <artifactId>atcrowdfunding03-admin-component</artifactId>
        <version>1.0-SNAPSHOT</version>
    </dependency>
</dependencies>
```

![image-20210508165021513](C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210508165021513.png)

其他依赖也是这样操作



## 3、创建数据库和数据库表

### 3.1、创建数据库

```sql
CREATE DATABASE `project_crowd` CHARACTER SET utf8;
```

### 3.3、创建管理员数据库表

```sql
USE project_crowd;
DROP TABLE IF EXISTS t_admin;
CREATE TABLE t_admin
(
id INT NOT NULL AUTO_INCREMENT, # 主键
login_acct VARCHAR(255) NOT NULL, # 登录账号
user_pswd CHAR(32) NOT NULL, # 登录密码
user_name VARCHAR(255) NOT NULL, # 昵称
email VARCHAR(255) NOT NULL, # 邮件地址
create_time CHAR(19), # 创建时间
PRIMARY KEY (id)
);
```

## 4、基于 Maven 的 MyBatis 逆向工

### 4.1、pom 配置

![image-20210508171508735](C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210508171508735.png)

```xml
    <dependencies>
        <dependency>
            <groupId>org.mybatis</groupId>
            <artifactId>mybatis</artifactId>
            <version>3.2.8</version>
        </dependency>
    </dependencies>

    <!-- 控制 Maven 在构建过程中相关配置 -->
    <build>
        <!-- 构建过程中用到的插件 -->
        <plugins>
            <!-- 具体插件，逆向工程的操作是以构建过程中插件形式出现的 -->
            <plugin>
                <groupId>org.mybatis.generator</groupId>
                <artifactId>mybatis-generator-maven-plugin</artifactId>
                <version>1.3.0</version>
                <!-- 插件的依赖 -->
                <dependencies>
                    <!-- 逆向工程的核心依赖 -->
                    <dependency>
                        <groupId>org.mybatis.generator</groupId>
                        <artifactId>mybatis-generator-core</artifactId>
                        <version>1.3.2</version>
                    </dependency>
                    <!-- 数据库连接池 -->
                    <dependency>
                        <groupId>com.mchange</groupId>
                        <artifactId>c3p0</artifactId>
                        <version>0.9.2</version>
                    </dependency>
                    <!-- MySQL 驱动 -->
                    <dependency>
                        <groupId>mysql</groupId>
                        <artifactId>mysql-connector-java</artifactId>
                        <version>5.1.8</version>
                    </dependency>
                </dependencies>
            </plugin>
        </plugins>
    </build>
```

### 4.2、generatorConfig.xml

![image-20210508171628174](C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210508171628174.png)

```xml
<!DOCTYPE generatorConfiguration
        PUBLIC "-//mybatis.org//DTD MyBatis Generator Configuration 1.0//EN"
        "http://mybatis.org/dtd/mybatis-generator-config_1_0.dtd">
<generatorConfiguration>
    <!-- mybatis-generator:generate -->
    <context id="atguiguTables" targetRuntime="MyBatis3">
        <commentGenerator>
            <!-- 是否去除自动生成的注释 true:是;false:否 -->
            <property name="suppressAllComments" value="true"/>
        </commentGenerator>
        <!--数据库连接的信息：驱动类、连接地址、用户名、密码 -->
        <jdbcConnection
                driverClass="com.mysql.jdbc.Driver" connectionURL="jdbc:mysql://localhost:3306/project_crowd"
                userId="root" password="9468">
        </jdbcConnection>
        <!-- 默认 false，把 JDBC DECIMAL 和 NUMERIC 类型解析为 Integer，为 true 时把
        JDBC DECIMAL
        和 NUMERIC 类型解析为 java.math.BigDecimal -->
        <javaTypeResolver>
            <property name="forceBigDecimals" value="false"/>
        </javaTypeResolver>
        <!-- targetProject:生成 Entity 类的路径 -->
        <javaModelGenerator targetProject=".\src\main\java"
                            targetPackage="com.atguigu.crowd.entity">
            <!-- enableSubPackages:是否让 schema 作为包的后缀 -->
            <property name="enableSubPackages" value="false"/>
            <!-- 从数据库返回的值被清理前后的空格 -->
            <property name="trimStrings" value="true"/>
        </javaModelGenerator>
        <!-- targetProject:XxxMapper.xml 映射文件生成的路径 -->
        <sqlMapGenerator targetProject=".\src\main\java"
                         targetPackage="com.atguigu.crowd.mapper">
            <!-- enableSubPackages:是否让 schema 作为包的后缀 -->
            <property name="enableSubPackages" value="false"/>
        </sqlMapGenerator>
        <!-- targetPackage：Mapper 接口生成的位置 -->
        <javaClientGenerator type="XMLMAPPER"
                             targetProject=".\src\main\java"
                             targetPackage="com.atguigu.crowd.mapper">
            <!-- enableSubPackages:是否让 schema 作为包的后缀 -->
            <property name="enableSubPackages" value="false"/>
        </javaClientGenerator>
        <!-- 数据库表名字和我们的 entity 类对应的映射指定 -->
        <table tableName="t_admin" domainObjectName="Admin"/>
    </context>
</generatorConfiguration>
```

### 4.3、执行逆向生成操作的 Maven 命令

![image-20210508171710143](C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210508171710143.png)

### 4.4、逆向工程生成的资源各归各位

WebUI 工程将来在 Tomcat 上运行时，现在 resources 目录下的资源会直接放在 WEB-INF/classes 目录（也就是类路径）下，所以放在 resources 目录下运行的时候更容 易找到。

![image-20210508171825811](C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210508171825811.png)

![image-20210508171855003](C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210508171855003.png)

![image-20210508172035784](C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210508172035784.png)

## 5、父工程依赖

### 5.1、版本声明

```xml
<properties>
    <!-- 声明属性，对 Spring 的版本进行统一管理 -->
    <atguigu.spring.version>4.3.20.RELEASE</atguigu.spring.version>
    <!-- 声明属性，对 SpringSecurity 的版本进行统一管理 -->
    <atguigu.spring.security.version>4.2.10.RELEASE</atguigu.spring.security.version>
</properties>
```

### 5.2、依赖管理

```xml
<dependencies>
    <!-- Spring 依赖 -->
    <!-- https://mvnrepository.com/artifact/org.springframework/spring-orm -->
    <dependency>
        <groupId>org.springframework</groupId>
        <artifactId>spring-orm</artifactId>
        <version>${atguigu.spring.version}</version>
    </dependency>
    <!-- https://mvnrepository.com/artifact/org.springframework/spring-webmvc -->
    <dependency>
        <groupId>org.springframework</groupId>
        <artifactId>spring-webmvc</artifactId>
        <version>${atguigu.spring.version}</version>
    </dependency>
    <dependency>
        <groupId>org.springframework</groupId>
        <artifactId>spring-test</artifactId>
        <version>${atguigu.spring.version}</version>
    </dependency>

    <!-- https://mvnrepository.com/artifact/org.aspectj/aspectjweaver -->
    <dependency>
        <groupId>org.aspectj</groupId>
        <artifactId>aspectjweaver</artifactId>
        <version>1.9.2</version>
    </dependency>
    <!-- https://mvnrepository.com/artifact/cglib/cglib -->
    <dependency>
        <groupId>cglib</groupId>
        <artifactId>cglib</artifactId>
        <version>2.2</version>
    </dependency>

    <!-- 数据库依赖 -->
    <!-- MySQL 驱动 -->
    <dependency>
        <groupId>mysql</groupId>
        <artifactId>mysql-connector-java</artifactId>
        <version>5.1.3</version>
    </dependency>
    <!-- 数据源 -->
    <dependency>
        <groupId>com.alibaba</groupId>
        <artifactId>druid</artifactId>
        <version>1.0.31</version>
    </dependency>
    <!-- MyBatis -->
    <dependency>
        <groupId>org.mybatis</groupId>
        <artifactId>mybatis</artifactId>
        <version>3.2.8</version>
    </dependency>
    <!-- MyBatis 与 Spring 整合 -->
    <dependency>
        <groupId>org.mybatis</groupId>
        <artifactId>mybatis-spring</artifactId>
        <version>1.2.2</version>
    </dependency>
    <!-- MyBatis 分页插件 -->
    <dependency>
        <groupId>com.github.pagehelper</groupId>
        <artifactId>pagehelper</artifactId>
        <version>4.0.0</version>
    </dependency>

    <!-- 日志 -->
    <dependency>
        <groupId>org.slf4j</groupId>
        <artifactId>slf4j-api</artifactId>
        <version>1.7.7</version>
    </dependency>
    <dependency>
        <groupId>ch.qos.logback</groupId>
        <artifactId>logback-classic</artifactId>
        <version>1.2.3</version>
    </dependency>
    <!-- 其他日志框架的中间转换包 -->
    <dependency>
        <groupId>org.slf4j</groupId>
        <artifactId>jcl-over-slf4j</artifactId>
        <version>1.7.25</version>
    </dependency>
    <dependency>
        <groupId>org.slf4j</groupId>
        <artifactId>jul-to-slf4j</artifactId>
        <version>1.7.25</version>
    </dependency>

    <!-- Spring 进行 JSON 数据转换依赖 -->
    <dependency>
        <groupId>com.fasterxml.jackson.core</groupId>
        <artifactId>jackson-core</artifactId>
        <version>2.9.8</version>
    </dependency>
    <dependency>
        <groupId>com.fasterxml.jackson.core</groupId>
        <artifactId>jackson-databind</artifactId>
        <version>2.9.8</version>
    </dependency>

    <!-- JSTL 标签库 -->
    <dependency>
        <groupId>jstl</groupId>
        <artifactId>jstl</artifactId>
        <version>1.2</version>
    </dependency>

    <!-- junit 测试 -->
    <dependency>
        <groupId>junit</groupId>
        <artifactId>junit</artifactId>
        <version>4.12</version>
        <scope>test</scope>
    </dependency>

    <!-- 引入 Servlet 容器中相关依赖 -->
    <dependency>
        <groupId>javax.servlet</groupId>
        <artifactId>servlet-api</artifactId>
        <version>2.5</version>
        <scope>provided</scope>
    </dependency>

    <!-- JSP 页面使用的依赖 -->
    <dependency>
        <groupId>javax.servlet.jsp</groupId>
        <artifactId>jsp-api</artifactId>
        <version>2.1.3-b06</version>
        <scope>provided</scope>
    </dependency>

    <!-- https://mvnrepository.com/artifact/com.google.code.gson/gson -->
    <dependency>
        <groupId>com.google.code.gson</groupId>
        <artifactId>gson</artifactId>
        <version>2.8.5</version>
    </dependency>

    <!-- SpringSecurity 对 Web 应用进行权限管理 -->
    <dependency>
        <groupId>org.springframework.security</groupId>
        <artifactId>spring-security-web</artifactId>
        <version>4.2.10.RELEASE</version>
    </dependency>
    <!-- SpringSecurity 配置 -->
    <dependency>
        <groupId>org.springframework.security</groupId>
        <artifactId>spring-security-config</artifactId>
        <version>4.2.10.RELEASE</version>
    </dependency>
    <!-- SpringSecurity 标签库 -->
    <dependency>
        <groupId>org.springframework.security</groupId>
        <artifactId>spring-security-taglibs</artifactId>
        <version>4.2.10.RELEASE</version>
    </dependency>
</dependencies>
```

## 6、Spring 整合 MyBatis

### 6.1、目标

adminMapper 通过 IOC 容器装配到当前组件中后，就可以直接调用它的方法，享受 到框架给我们提供的方便

### 6.2、思路

![image-20210508172326156](C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210508172326156.png)

### 6.3、操作清单

- 在子工程中加入搭建环境所需要的具体依赖
- 准备 jdbc.properties
- 创建 Spring 配置文件专门配置 Spring 和 MyBatis 整合相关
- 在 Spring 的配置文件中加载 jdbc.properties 属性文件
- 配置数据源
- 测试从数据源中获取数据库连接
- 配置 SqlSessionFactoryBean
  - 装配数据源
  - 指定 XxxMapper.xml 配置文件的位
  - 指定 MyBatis 全局配置文件的位置（可选）
- 配置 MapperScannerConfigurer
- 测试是否可以装配 XxxMapper 接口并通过这个接口操作数据

### 6.4、操作步骤详解

#### 1、 在子工程中加入搭建环境所需的具体依赖

Idea中不需要操作

#### 2、 数据库连接信息

![image-20210508172623459](C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210508172623459.png)

```properties
jdbc.user=root
jdbc.password=9468
jdbc.url=jdbc:mysql://localhost:3306/project_crowd?useUnicode=true&characterEncoding=UTF-8
jdbc.driver=com.mysql.jdbc.Driver
```

#### 3、mybatis-config.xml

![image-20210508172719574](C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210508172719574.png)

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE configuration PUBLIC "-//mybatis.org//DTD Config 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-config.dtd">
<configuration>



</configuration>
```

#### 4、创建 spring-persist-mybatis.xm、第一步：配置数据源

![image-20210508173041664](C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210508173041664.png)

```xml
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:context="http://www.springframework.org/schema/context"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
                           http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-4.2.xsd">

    <!--加载外部属性文件-->
    <context:property-placeholder location="classpath:jdbc.properties"/>

    <!--配置数据源-->
    <bean id="dataSource" class="com.alibaba.druid.pool.DruidDataSource">
        <property name="username" value="${jdbc.user}"/>
        <property name="password" value="${jdbc.password}"/>
        <property name="url" value="${jdbc.url}"/>
        <property name="driverClassName" value="${jdbc.driver}"/>
    </bean>
</beans>
```

创建 Spring 的 Junit 测试

```java
@RunWith(SpringJUnit4ClassRunner.class)
//加载配置文件
@ContextConfiguration(locations = {"classpath:spring-persist-mybatis.xml"})
public class CrowdTest {

    @Autowired
    private DataSource dataSource;

    @Test
    public void testConnection() throws Exception{
        Connection connection = dataSource.getConnection();
        System.out.println(connection);
    }

}
```

运行结果：

![image-20210508173215242](C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210508173215242.png)

#### 5、第二步 配置 SqlSessionFactoryBean

```xml
<!--配置SqlSessionFactoryBean整合MyBatis-->
<bean id="sqlSessionFactoryBean" class="org.mybatis.spring.SqlSessionFactoryBean">
    <!-- 指定 MyBatis 全局配置文件位置 -->
    <property name="configLocation" value="classpath:mybatis/mybatis-config.xml"/>
    <!-- 指定 Mapper.xml 配置文件位置 -->
    <property name="mapperLocations" value="classpath:mybatis/mapper/*Mapper.xml"/>
    <!-- 装配数据源 -->
    <property name="dataSource" ref="dataSource"/>
</bean>
```

#### 6、第三步 配置 MapperScannerConfigure

```xml
<!-- 配置 MapperScannerConfigurer -->
<!-- 把 MyBatis 创建的 Mapper 接口类型的代理对象扫描到 IOC 容器中-->
<bean id="mapperScannerConfigurer" class="org.mybatis.spring.mapper.MapperScannerConfigurer">
    <!-- 使用 basePackage 属性指定 Mapper 接口所在包 -->
    <property name="basePackage" value="com.atguigu.crowd.mapper"/>
</bean>
```

测试一下插入是否成功

```java
@Autowired
private AdminMapper adminMapper;

@Test
public void testInsertAdmin() {
    Admin admin = new Admin(null, "leige", "123456", "磊哥", "leige@163.com", null);
    adminMapper.insert(admin);
}
```

![image-20210508194743391](C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210508194743391.png)

## 7、日志系统

### 1、更换框架的日志系统

第一步：排除 commons-logging

下载一个插件

![image-20210508202654297](C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210508202654297.png)

![image-20210508202710649](C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210508202710649.png)

![image-20210508202723293](C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210508202723293.png)

搜索commons-logging再exclude就好了

![image-20210508202804384](C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210508202804384.png)

### 2、logback 配置文

logback 工作时的具体细节可以通过 logback.xml 来配置。

```xml
<?xml version="1.0" encoding="UTF-8" ?>
<configuration debug="true">
    <!-- 指定日志输出的位置 -->
    <appender name="STDOUT" class="ch.qos.logback.core.ConsoleAppender">
        <encoder>
            <!-- 日志输出的格式 -->
            <!-- 按照顺序分别是：时间、日志级别、线程名称、打印日志的类、日志主体
            内容、换行 -->
            <pattern>[%d{HH:mm:ss.SSS}] [%-5level] [%thread] [%logger] [%msg]%n</pattern>
        </encoder>
    </appender>
    <!-- 设置全局日志级别。日志级别按顺序分别是：DEBUG、INFO、WARN、ERROR -->
    <!-- 指定任何一个日志级别都只打印当前级别和后面级别的日志。 -->
    <root level="INFO">
        <!-- 指定打印日志的 appender，这里通过“STDOUT”引用了前面配置的 appender -->
        <appender-ref ref="STDOUT" />
    </root>
    <!-- 根据特殊需求指定局部日志级别 -->
    <logger name="com.atguigu.crowd.mapper" level="DEBUG"/>
</configuration>
```

## 8、声明式事务

### 1、加入AOP依赖

### 2、创建Spring配置文件

![image-20210509093122492](C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210509093122492.png)

```xml
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:context="http://www.springframework.org/schema/context"
       xmlns:aop="http://www.springframework.org/schema/aop"
       xmlns:tx="http://www.springframework.org/schema/tx"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
                           http://www.springframework.org/schema/context  http://www.springframework.org/schema/context/spring-context.xsd
                           http://www.springframework.org/schema/aop  http://www.springframework.org/schema/aop/spring-aop.xsd
                           http://www.springframework.org/schema/tx  http://www.springframework.org/schema/tx/spring-tx.xsd">

</beans>
```

### 3、配置自动扫描的包

- 创建这两个包

![image-20210509093653997](C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210509093653997.png)

- 在spring-persist-tx.xml中配置

```xml
<!--配置自动扫描包，把Service扫描到IOC容器中-->
<context:component-scan base-package="com.atguigu.crowd.service"/>
```

### 4、配置事务管理器

```xml
    <!-- 配置事务管理器 -->
    <bean id="txManager" class="org.springframework.jdbc.datasource.DataSourceTransactionManager">
        <!-- 装配数据源 -->
        <property name="dataSource" ref="dataSource"/>
    </bean>

    <!-- 配置 AOP -->
    <aop:config>
        <!-- 配置切入点表达式 -->
        <!--考虑到整合SpringSecurity，避免把UserDetailsService加入事务控制，让切入点表达式定位到ServiceImpl-->
        <aop:pointcut id="txPointCut" expression="execution(* *..*ServiceImpl.*(..))"/>
        <!-- 将事务通知和切入点表达式关联到一起 -->
        <aop:advisor advice-ref="txAdvice" pointcut-ref="txPointCut"/>
    </aop:config>

    <!--配置事务通知-->
    <tx:advice id="txAdvice" transaction-manager="txManager">
        <!--配置事务属性-->
        <tx:attributes>
            <!--查询方法：配置只读，让数据库知道这是一个查询操作，能进行一定优化-->
            <tx:method name="get*" read-only="true"/>
            <tx:method name="find*" read-only="true"/>
            <tx:method name="query*" read-only="true"/>
            <tx:method name="count*" read-only="true"/>

            <!--增删改方法：配置事务的传播行为、回滚异常-->
            <!--
                propagation:
                    REQUIRED:默认，当前方法必须工作在事务中，如果当前线程上没有已经开启的事务，则自己开新事务，如果已经有了，就用已经存在的事务
                        用别人的事务被回滚
                    REQUIRES_NEW：建议使用，不管当前线程是否存在事务，都要自己开事务，在自己的事务中进行
                        不会受到其他事务回滚的影响
                rollback-for：配置事务方法针对什么样的异常回滚
                    默认：运行时异常回滚
                    建议：编译时异常和运行时异常都回滚
            -->
            <tx:method name="save*" propagation="REQUIRES_NEW" rollback-for="java.lang.Exception"/>
            <tx:method name="update*" propagation="REQUIRES_NEW" rollback-for="java.lang.Exception"/>
            <tx:method name="remove*" propagation="REQUIRES_NEW" rollback-for="java.lang.Exception"/>
            <tx:method name="batch*" propagation="REQUIRES_NEW" rollback-for="java.lang.Exception"/>
        </tx:attributes>
    </tx:advice>
```

### 5、测试

![image-20210509100645832](C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210509100645832.png)

```java
@Service
public class AdminServiceImpl implements AdminService {

    @Autowired
    private AdminMapper adminMapper;

    @Override
    public void saveAdmin(Admin admin) {
        adminMapper.insert(admin);
    }

}
```

测试类加载配置文件spring-persist-tx.xml

![image-20210509101831169](C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210509101831169.png)

```java
@Test
public void testTx() {
    Admin admin = new Admin(null,"shuaige","123456","帅哥","shuaige@123.com",null);
    adminService.saveAdmin(admin);
}
```

![image-20210509101900282](C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210509101900282.png)

### 6、注意

在基于xml的声明式事务中，事务属性的tx:method是必须配置的，如果某个方法没有配置对应的tx:method，那么事务对这个方法就不生效



## 9、表述层的配置

jsp不导出问题解决

![image-20210509112112262](C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210509112112262.png)

![image-20210509112151972](C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210509112151972.png)

### 1、web.xml和Spring配置文件的关系

![image-20210509114139790](C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210509114139790.png)

### 2、加入依赖

```xml
<!-- 引入 Servlet 容器中相关依赖 -->
<dependency>
    <groupId>javax.servlet</groupId>
    <artifactId>servlet-api</artifactId>
    <version>2.5</version>
    <scope>provided</scope>
</dependency>

<!-- JSP 页面使用的依赖 -->
<dependency>
    <groupId>javax.servlet.jsp</groupId>
    <artifactId>jsp-api</artifactId>
    <version>2.1.3-b06</version>
    <scope>provided</scope>
</dependency>
```

### 3、web.xml的配置

<img src="C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210509114320522.png"  />

1、 ContextLoaderListener

作用：加载 Spring 的配置文件，根据 Spring 的配置文件初始化 IOC 容器。

```xml
<!-- 配置 ContextLoaderListener 加载 Spring 配置文件 -->
<!-- needed for ContextLoaderListener -->
<context-param>
    <param-name>contextConfigLocation</param-name>
    <param-value>classpath:spring-persist-*.xml</param-value>
</context-param>

<!-- Bootstraps the root web application context before servlet initialization -->
<listener>
    <listener-class>org.springframework.web.context.ContextLoaderListener</listener-class>
</listener>
```

2、CharacterEncodingFilter

解决 POST 请求的字符乱码问题。需要注意的是：在 web.xml 中存在多个 Filter 时，让这个 Filter 作为过滤器链中的第一个 Filter。 request.setCharacterEncoding(encoding) 要 求 必 须 在 所 有 request.getParameter(xxx)操作前面 response.setCharacterEncoding(encoding)要求必须在所有 response.getWriter() 操作前面 不满足这个顺序要求字符集设定无法生效

```xml
<!-- 配置 CharacterEncodingFilter 解决 POST 请求的字符乱码问题 -->
<filter>
    <filter-name>CharacterEncodingFilter</filter-name>
    <filter-class>org.springframework.web.filter.CharacterEncodingFilter</filter-class>
    <!-- 指定字符集 -->
    <init-param>
        <param-name>encoding</param-name>
        <param-value>UTF-8</param-value>
    </init-param>
    <!-- 强制请求进行编码 -->
    <init-param>
        <param-name>forceRequestEncoding</param-name>
        <param-value>true</param-value>
    </init-param>
    <!-- 强制响应进行编码 -->
    <init-param>
        <param-name>forceResponseEncoding</param-name>
        <param-value>true</param-value>
    </init-param>
</filter>

<filter-mapping>
    <filter-name>CharacterEncodingFilter</filter-name>
    <url-pattern>/*</url-pattern>
</filter-mapping>
```

3、DispatcherServlet

```xml
<!-- 配置 SpringMVC 的前端控制器 -->
<servlet>
    <servlet-name>springDispatcherServlet</servlet-name>
    <servlet-class>org.springframework.web.servlet.DispatcherServlet</servlet-class>
    <init-param>
        <param-name>contextConfigLocation</param-name>
        <param-value>classpath:spring-web-mvc.xml</param-value>
    </init-param>
    <!-- 让 DispatcherServlet 在 Web 应用启动时创建对象、初始化 -->
    <!-- 默认情况：Servlet 在第一次请求的时候创建对象、初始化 -->
    <load-on-startup>1</load-on-startup>
</servlet>
<servlet-mapping>
    <servlet-name>springDispatcherServlet</servlet-name>
    <!-- DispatcherServlet 映射的 URL 地址 -->
    <!-- 大白话：什么样的访问地址会交给 SpringMVC 来处理 -->
    <!-- 配置方式一：符合 RESTFUL-->
    <!--<url-pattern>/</url-pattern>-->

    <!-- 配置方式二：请求扩展名 -->
    <url-pattern>*.html</url-pattern>
    <url-pattern>*.json</url-pattern>
</servlet-mapping>
```

### 4、请求扩展名

#### 1、*.html 扩展名

- 举例 http://localhost:8080/atcrowdfunding02-admin-webui/save/emp.html
- 作用：伪静态 表面上看起来是一个访问静态资源的请求，但是实际上是由SpringMVC 交给 handler 来处理的动态资源。
  - 好处 1：有利于 SEO 优化 让搜索引擎更容易找到我们的网站，有利于网站的推广
  - 好处 2：隐藏后端技术实现细节 给黑客入侵系统增加难度
  - 好处 3：自动解决静态资源访问问题 访问 a.png 本身不符合*.html 这个 url-pattern，和 SpringMVC 完全没 有关系，当前请求由 Tomcat 处理。 如 果 url-pattern 映 射 了 “ / ”， 那 么 SpringMVC 中 还 需 要 配 置 DefaultServletHandler。
  - 缺陷：不符合 RESTFUL

#### 2、*.json 扩展名

- 提出问题

![image-20210509142139863](C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210509142139863.png)

- 描述问题

  请求扩展名 http://localhost:8080/extra01-ajax/get/emp/by/ajax.html 

  服务器端打算返回的数据：JSON 格式 

  二者不匹配

- 分析问题 

  请求扩展名和响应体的数据格式不匹配

- 解决问题

  让请求扩展名和预计的响应体数据格式一致。 http://localhost:8080/extra01-ajax/get/emp/by/ajax.json 同时让 SpringMVC 在映射*.html 扩展名之外再映射*.json 扩展名，不然会 返回 404

```xml
<servlet-mapping>
    <servlet-name>springDispatcherServlet</servlet-name>
    <!-- DispatcherServlet 映射的 URL 地址 -->
    <!-- 大白话：什么样的访问地址会交给 SpringMVC 来处理 -->
    <!-- 配置方式一：符合 RESTFUL-->
    <!--<url-pattern>/</url-pattern>-->

    <!-- 配置方式二：请求扩展名 -->
    <url-pattern>*.html</url-pattern>
    <url-pattern>*.json</url-pattern>
</servlet-mapping>
```

### 5、spring-web-mvc.xml 配置

![image-20210509142751906](C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210509142751906.png)

#### 1、命名空间

```xml
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:context="http://www.springframework.org/schema/context"
       xmlns:mvc="http://www.springframework.org/schema/mvc"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
                           http://www.springframework.org/schema/context  http://www.springframework.org/schema/context/spring-context.xsd
                           http://www.springframework.org/schema/mvc http://www.springframework.org/schema/mvc/spring-mvc.xsd">

</beans>
```

#### 2、创建 SpringMVC 扫描的

![image-20210509143310468](C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210509143310468.png)

#### 3、具体配置

```xml
<!--配置自动扫描的包：扫描Controller-->
<context:component-scan base-package="com.atguigu.crowd.mvc"/>

<!--配置SpringMVC的注解驱动-->
<mvc:annotation-driven/>

<!--配置视图解析器-->
<!-- 配置视图解析器 -->
<!-- 拼接公式→前缀+逻辑视图+后缀=物理视图 -->
<!-- @RequestMapping("/xxx/xxx")
public String xxx() {
// 这个返回值就是逻辑视图
return "target";
}
物理视图是一个可以直接转发过去的地址
物理视图："/WEB-INF/"+"target"+".jsp" 转发路径："/WEB-INF/target.jsp"
-->
<bean id="viewResolver" class="org.springframework.web.servlet.view.InternalResourceViewResolver">
    <!-- 前缀：附加到逻辑视图名称前 -->
    <property name="prefix" value="/WEB-INF/"/>
    <!-- 后缀：附加到逻辑视图名称后 -->
    <property name="suffix" value=".jsp"/>
</bean>
```

### 6、页面上的 base 标签

#### 1、作用

将页面上路径中的${pageContext.request.contextPath}部分提取到页面开头

#### 2、写法

```xml
<base href="http://${pageContext.request.serverName}:${pageContext.request.serverPort}/">
```

#### 3、需要注意的点

- base 标签必须写在 head 标签内部
- base 标签必须在所有“带具体路径”的标签的前面
- serverName 部分 EL 表达式和 serverPort 部分 EL 表达式之间必须写“:”
- serverPort 部分 EL 表达式和 contextPath 部分 EL 表达式之间绝对不能写“/“
  - 原因：contextPath 部分 EL 表达式本身就是“/”开头
  - 如果多写一个“/”会干扰 Cookie 的工作机制
- serverPort 部分 EL 表达式后面必须写“

### 7、测试

#### 1、创建 Controller 类

![image-20210509150301754](C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210509150301754.png)

#### 2、编写Controller方法

```java
@Controller
public class TestController {

    @Autowired
    private AdminService adminService;

    @RequestMapping("/test/ssm.html")
    public String testSSM (Model model) {

        List<Admin> adminList = adminService.getAll();

        model.addAttribute("adminList",adminList);

        return "target";
    }

}
```

#### 3、创建目标 JSP 页面（视图）

![image-20210509150402914](C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210509150402914.png)

```jsp
<%@ page contentType="text/html;charset=UTF-8" language="java" %>
<html>
  <head>
    <title>$Title$</title>
    <base href="http://${pageContext.request.serverName}:${pageContext.request.serverPort}/">
  </head>
  <body>
  <a href="test/ssm.html">测试SSM整合环境</a>
  </body>
</html>
```

## 11、SpringMVC 环境下的 Ajax 请求

#### 1、建立意识

前端发送过来，后端要处理的请求有两种： 

- 普通请求：后端处理完成后返回页面，浏览器使用使用页面替换整个窗口中的 内容 
- Ajax 请求：后端处理完成后通常返回 JSON 数据，jQuery 代码使用 JSON 数据 对页面局部更新

#### 2、常用注解

![image-20210509152025485](C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210509152025485.png)

@ResponseBody和@RequestBody要正常工作必须有jackson的支持，确认当前环境引入如下依赖

```xml
<!-- Spring 进行 JSON 数据转换依赖 -->
<dependency>
    <groupId>com.fasterxml.jackson.core</groupId>
    <artifactId>jackson-core</artifactId>
    <version>2.9.8</version>
</dependency>
<dependency>
    <groupId>com.fasterxml.jackson.core</groupId>
    <artifactId>jackson-databind</artifactId>
    <version>2.9.8</version>
</dependency>
```

同时必须配置了mvc:annotation-driven

#### 3、@RequestBody 注解的使用

引入jQuery

![image-20210509155454997](C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210509155454997.png)

```jsp
<script type="text/javascript" src="jquery/jquery-2.1.1.min.js"></script>
```

1、场景设定

jQuery 通过 Ajax 请求给服务器端发送一个数组：[5,8,12]

2、尝试方案一【**不建议采用**】

jQuery代码

```jsp
<script type="text/javascript">

  $(function () {
      $("#btn1").click(function () {

        $.ajax({
          "url": "send/array.html",
          "type": "post",
          "data": {
            "array": [5,6,12]
          },
          "dataType": "text",
          "success": function (response) {
              alert(response);
          },
          "error": function (response) {
              alert(response);
          }
        });

      });
  });

</script>

-----------------------------------------------------------
按钮
<button id="btn1">Send [5,8,12]</button>
```

Controller代码

```java
@ResponseBody
@RequestMapping("/send/array.html")
//array[] 要写成这样
public String testReceiveArrayOne(@RequestParam("array[]")List<Integer> array) {
    for (Integer integer : array) {
        System.out.println("number:" + integer);
    }

    return "success";
}
```

jQuery 私自在请求参数名字后面附加了“[]”

![image-20210509155824579](C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210509155824579.png)

3、尝试方案二

jQuery代码

```javascript
var array = [5,8,12];

var requestBody = JSON.stringify(array);

$("#btn3").click(function () {
  $.ajax({
    "url": "send/array/three.html",
    "type": "post",
    "data": requestBody,
    "contentType": "application/json;charset=UTF-8",
    "dataType": "text",
    "success": function (response) {
      alert(response);
    },
    "error": function (response) {
      alert(response);
    }
  });
});
```

Controller代码

```java
@ResponseBody
@RequestMapping("/send/array/three.html")
public String testReceiveArrayThree(@RequestBody List<Integer> array) {

    Logger logger = LoggerFactory.getLogger(TestController.class);

    for (Integer integer : array) {
        logger.info("number:" + integer);
    }

    return "success";
}
```

![image-20210509162507880](C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210509162507880.png)

4、要注意的点

- 前端

  - 首先准备好要发送的 JSON 数

    - JSON 对象
    - JSON 数组

  - 将 JSON 对象或 JSON 数组转换为 JSON 字符串

     var arrayStr = JSON.stringify(array);

  - 将 JSON 字符串直接赋值给 data 属性

    "data":arrayStr

  - 必须要设置 contentType

    "contentType":"application/json;charset=UTF-8"

- 后端

  - 加入 jackson 依赖
  - 开启注解驱动
  - 使用注解 @RequestBody List<Integer> array

5、发送复杂对象举例

实体类

![image-20210509165522877](C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210509165522877.png)

```java
public class Student {

    private Integer stuId;
    private String name;
    private Address address;
    private List<Subject> subjects;
    private Map<String,String> map;
```

```java
public class Address {

    private String province;
    private String city;
    private String street;
```

```java
public class Subject {

    private String subjectName;
    private Integer subjectScore;
```

前端发送数据

```javascript
$("#btn4").click(function () {
    // 准备要发送的 JSON 数据
    var student = {
        "stuId": 5,
        "name": "leige",
        "address": {
            "province": "zhejiang",
            "city": "hangzhou",
            "street": "gongshu"
        },
        "subjects": [
            {
                "subjectName": "语文",
                "subjectScore": 98,
            },
            {
                "subjectName": "数学",
                "subjectScore": 22,
            }
        ],
        "map": {
            "1": "333",
            "2": "444",
            "3": "555",
        }
    };

    // 将 JSON 对象转换为 JSON 字符串
    var requestBody = JSON.stringify(student);

    // 发送 Ajax 请求
    $.ajax({
        "url": "send/compose/object.html",
        "type": "post",
        "data": requestBody,
        "contentType": "application/json;charset=UTF-8",
        "dataType": "text",
        "success": function (response) {
            alert(response);
        },
        "error": function (response) {
            alert(response);
        }
    });
});
```

浏览器开发者工具中看到的请求体

![image-20210509165643122](C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210509165643122.png)

后端接收数据

```java
@ResponseBody
@RequestMapping("/send/compose/object.html")
public String testReceiveComposeObject(@RequestBody Student student) {
    logger.info(student.toString());
    return "success";
}
```

#### 4、对Ajax请求返回的数据进行规范

![image-20210509195624996](C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210509195624996.png)

```java
package com.atguigu.crowd.util;

/**
 * 统一整个项目中Ajax请求返回的结果（未来也可以用于分布式架构各个模块间调用时返回统一类型）
 * @param <T>
 */
public class ResultEntity<T> {

    public static final String SUCCESS = "SUCCESS";
    public static final String FAILED = "FAILED";

    //用来封装当前请求处理的结果是成功还是失败
    private String result;

    //请求处理失败时返回错误消息
    private String message;

    //要返回的数据
    private T data;

    /**
     * 请求处理成功且不需要返回数据时使用的方法
     * @param <Type>
     * @return
     */
    public static <Type> ResultEntity<Type> successWithoutData() {
        return new ResultEntity<>(SUCCESS,null,null);
    }

    /**
     * 请求处理成功且需要返回数据时使用的方法
     * @param data 数据
     * @param <Type>
     * @return
     */
    public static <Type> ResultEntity<Type> successWithData(Type data) {
        return new ResultEntity<>(SUCCESS,null,data);
    }

    /**
     * 请求处理失败时使用的方法
     * @param message 失败的错误消息
     * @param <Type>
     * @return
     */
    public static <Type> ResultEntity<Type> failed(String message) {
        return new ResultEntity<>(FAILED,message,null);
    }


    public ResultEntity() {
    }

    public ResultEntity(String result, String message, T data) {
        this.result = result;
        this.message = message;
        this.data = data;
    }

    public String getResult() {
        return result;
    }

    public void setResult(String result) {
        this.result = result;
    }

    public String getMessage() {
        return message;
    }

    public void setMessage(String message) {
        this.message = message;
    }

    public T getData() {
        return data;
    }

    public void setData(T data) {
        this.data = data;
    }

    @Override
    public String toString() {
        return "ResultEntity{" +
                "result='" + result + '\'' +
                ", message='" + message + '\'' +
                ", data=" + data +
                '}';
    }
}
```

## 12、异常映射

### 1、目标

使用异常映射机制将整个项目的异常和错误提示进行统一管理。

### 2、思路

![image-20210509205613247](C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210509205613247.png)

注意：SpringMVC提供了基于XML和基于注解的两种异常映射机制。

<img src="C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210509210006106.png" alt="image-20210509210006106"  />

### 3、代码

![image-20210509215640144](C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210509215640144.png)

#### 3.1、基于xml

![image-20210509220122138](C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210509220122138.png)

```xml
<!--基于XML的异常映射-->
<bean id="simpleMappingExceptionResolver" class="org.springframework.web.servlet.handler.SimpleMappingExceptionResolver">
    <!--配置异常的类型和具体视图页面的关系-->
    <property name="exceptionMappings">
        <props>
            <!-- key 属性指定异常类型（全类名） -->
            <!-- 文本标签体中指定异常对应的逻辑视图名称(这个值要拼前后缀) -->
            <prop key="java.lang.Exception">system-error</prop>
        </props>
    </property>
</bean>
```

#### 3.2、判断请求类型的工具方法

![image-20210509215857252](C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210509215857252.png)

##### 1、加入依赖

```xml
<dependencies>
    <!-- 引入 Servlet 容器中相关依赖 -->
    <dependency>
        <groupId>javax.servlet</groupId>
        <artifactId>servlet-api</artifactId>
        <version>2.5</version>
        <scope>provided</scope>
    </dependency>
</dependencies>
```

##### 2、请求类型的判断依据

##### ![image-20210509220459648](C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210509220459648.png)3、创建工具类，编写工具方法

![image-20210509221650783](C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210509221650783.png)

```java
package com.atguigu.crowd.util;

import javax.servlet.http.HttpServletRequest;

public class CrowdUtil {

    /**
     * 判断当前请求是否为ajax请求
     * @param request 请求对象
     * @return true 当前请求是ajax请求；false 不是ajax请求
     */
    public static boolean judgeRequestType(HttpServletRequest request) {

        //获取请求消息头
        String acceptHeader = request.getHeader("Accept");
        String xRequestHeader = request.getHeader("X-Requested-With");

        //判断
        return (acceptHeader != null && acceptHeader.contains("application/json")) ||
                (xRequestHeader != null && xRequestHeader.equals("XMLHttpRequest"));
    }

}
```

### 3.3、基于注解

#### 1、创建异常处理类

![image-20210509225927164](C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210509225927164.png)

#### 2、异常处理代码

```java
package com.atguigu.crowd.mvc.config;

import com.atguigu.crowd.util.CrowdUtil;
import com.atguigu.crowd.util.ResultEntity;
import com.google.gson.Gson;
import org.springframework.web.bind.annotation.ControllerAdvice;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.servlet.ModelAndView;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;

//@ControllerAdvice表示当前类是一个基于注解的异常处理类
@ControllerAdvice
public class CrowdExceptionResolver {

    @ExceptionHandler(value = ArithmeticException.class)
    public ModelAndView resolveMathException(ArithmeticException exception,
                                             HttpServletRequest request,
                                             HttpServletResponse response) throws IOException {
        String viewName = "system-error";
        //返回ModelAndView对象
        return commonResolve(viewName,exception,request,response);
    }

    //@ExceptionHandler将一个具体的异常类型和一个方法关联起来
    @ExceptionHandler(value = NullPointerException.class)
    public ModelAndView resolveNullPointerException(NullPointerException exception,
                                                    HttpServletRequest request,
                                                    HttpServletResponse response) throws IOException {
        //指定要返回的视图的对象
        String viewName = "system-error";
        return commonResolve(viewName,exception,request,response);
    }

    /**
     * 通用的异常处理方法
     * @param viewName 异常处理完成后要去的页面
     * @param exception 实际捕获到的异常类型
     * @param request   当前请求对象
     * @param response  当前响应对象
     * @return
     * @throws IOException
     */
    private ModelAndView commonResolve(String viewName,Exception exception,HttpServletRequest request,HttpServletResponse response) throws IOException {
        //判断请求类型
        boolean judgeResult = CrowdUtil.judgeRequestType(request);


        //如果是ajax请求
        if (judgeResult) {

            //创建一个ResultEntity对象
            ResultEntity<Object> resultEntity = ResultEntity.failed(exception.getMessage());

            //创建一个Gson对象
            Gson gson = new Gson();

            //将resultEntity转换成json
            String json = gson.toJson(resultEntity);

            //将json字符串作为响应体返回给浏览器
            response.getWriter().write(json);

            //由于上面已经通过原生的response对象返回了响应，所以不提供ModelAndView对象
            return null;
        }

        //如果不是ajax请求，创建ModelAndView对象
        ModelAndView modelAndView = new ModelAndView();

        //将Exception对象存入模型
        modelAndView.addObject("exception",exception);

        //设置对应的视图名称
        modelAndView.setViewName(viewName);

        //返回ModelAndView对象
        return modelAndView;
    }

}
```

之后在添加异常处理方法只要表明异常类型和异常处理完成后返回的页面即可

## 13、以常量管理属性名和异常消息

![image-20210510101847026](C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210510101847026.png)

```java
package com.atguigu.crowd.constant;

/**
 * @author zhulei
 * @create 2021-05-10 10:17
 */
public class CrowdConstant {

    public static final String MESSAGE_LOGIN_FAILED = "抱歉，账号或密码错误，请重新输入";
    public static final String MESSAGE_LOGIN_ACCT_ALREADY_USED = "抱歉，该账号已被使用";
    public static final String MESSAGE_ACCESS_FORBIDDEN = "请登录以后再访问";

    public static final String ATTR_NAME_EXCEPTION = "exception";

}
```

之后所有的提示消息都放在这里

## 14、前端页面

### 1、静态资源导入

前端资源复制到web目录下

![image-20210510104008645](C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210510104008645.png)

### 2、创建后台管理员登录页面

1、创建admin-login.jsp文件

![image-20210510104326962](C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210510104326962.png)

2、页面文件

```jsp
<%@ page contentType="text/html;charset=UTF-8" language="java" %>
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="keys" content="">
    <meta name="author" content="">
    <base href="http://${pageContext.request.serverName}:${pageContext.request.serverPort}/">
    <link rel="stylesheet" href="bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="css/font-awesome.min.css">
    <link rel="stylesheet" href="css/login.css">
    <script src="jquery/jquery-2.1.1.min.js"></script>
    <script src="bootstrap/js/bootstrap.min.js"></script>
    <style>

    </style>
</head>
<body>
<nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <div><a class="navbar-brand" href="index.html" style="font-size:32px;">尚筹网-创意产品众筹平台</a></div>
        </div>
    </div>
</nav>

<div class="container">

    <form action="admin/do/login.html" method="post" class="form-signin" role="form">
        <h2 class="form-signin-heading"><i class="glyphicon glyphicon-log-in"></i> 管理员登录</h2>
        <div class="form-group has-success has-feedback">
            <input type="text" name="loginAccount" class="form-control" id="inputSuccess4" placeholder="请输入登录账号" autofocus>
            <span class="glyphicon glyphicon-user form-control-feedback"></span>
        </div>
        <div class="form-group has-success has-feedback">
            <input type="text" name="userPswd" class="form-control" id="inputSuccess4" placeholder="请输入登录密码" style="margin-top:10px;">
            <span class="glyphicon glyphicon-lock form-control-feedback"></span>
        </div>
        <button type="submit" class="btn btn-lg btn-success btn-block">登录</button>
    </form>
</div>

</body>
</html>
```

### 3、跳转到登录页面

![image-20210510105650173](C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210510105650173.png)

```xml
<!--配置view-controller,直接把请求地址和视图名称联系起来，不必写controller方法-->
<!--
    @RequestMapping("/admin/to/login/page.html")
    public String toLoginPage() {
    return "admin-login";
    }
-->
<mvc:view-controller path="/admin/to/login/page.html" view-name="admin-login"/>
```

### 4、layer弹层组件

1、加入layer库文件和样式文件

![image-20210510110131523](C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210510110131523.png)

2、在页面上引入layer环境

建议导入在jQuery下面

```jsp
<script type="text/javascript" src="jquery/jquery-2.1.1.min.js"></script>
<script type="text/javascript" src="layer/layer.js"></script>
```

3、使用layer弹出提示框

```javascript
$("#btn5").click(function () {
    layer.msg("Layer");
});
```





# 管理员登录

## 1、目标

识别操作系统的人的身份，控制他的行为。

## 2、思路

![image-20210510152846538](C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210510152846538.png)

## 3、代码

### 3.1、创建工具方法执行 MD5 加密

![image-20210510153027187](C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210510153027187.png)

```java
/**
 * 对明文字符串进行md5加密
 * @param source 传入的明文字符串
 * @return
 */
public static String md5(String source) {

    // 判断source是否有效
    if (source == null || source.length() == 0) {
        // 如果不是有效的字符串，抛出异常
        throw new RuntimeException(CrowdConstant.MESSAGE_STRING_INVALIDATE);
    }

    try {
        // 获取MessageDigest对象
        String algorithm = "md5";

        MessageDigest messageDigest = MessageDigest.getInstance(algorithm);

        // 获取明文字符串对应的字节数组
        byte[] input = source.getBytes();

        // 执行加密
        byte[] output = messageDigest.digest(input);

        // 创建BigInteger
        int signum = 1;
        BigInteger bigInteger = new BigInteger(signum, output);

        // 按照16进制将bigInteger的值转换为字符串
        int radix = 16; // 16进制
        String encoded = bigInteger.toString(radix).toUpperCase();

        return encoded;

    } catch (NoSuchAlgorithmException e) {
        e.printStackTrace();
    }

    return null;
}
```

### 3.2、创建登录失败异常

![image-20210510155525607](C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210510155525607.png)

```java
package com.atguigu.crowd.exception;

/**
 * 登录失败后抛出的异常
 * @author zhulei
 * @create 2021-05-10 15:53
 */
public class LoginFailedException extends RuntimeException{

    private static final long serialVersionUID = 1L;

    public LoginFailedException() {
    }

    public LoginFailedException(String message) {
        super(message);
    }

    public LoginFailedException(String message, Throwable cause) {
        super(message, cause);
    }

    public LoginFailedException(Throwable cause) {
        super(cause);
    }

    public LoginFailedException(String message, Throwable cause, boolean enableSuppression, boolean writableStackTrace) {
        super(message, cause, enableSuppression, writableStackTrace);
    }
}
```

### 3.3、在异常处理器类中增加登录失败异常的处理

![image-20210510160514234](C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210510160514234.png)

```java
@ExceptionHandler(value = LoginFailedException.class)
public ModelAndView resolveLoginFailedException(LoginFailedException exception,
                                         HttpServletRequest request,
                                         HttpServletResponse response) throws IOException {
    // 登录失败回到登录页面
    String viewName = "admin-login";
    // 返回ModelAndView对象
    return commonResolve(viewName,exception,request,response);
}
```

### 3.4、在登录页面显示异常消息

![image-20210510160607400](C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210510160607400.png)

```jsp
<form action="admin/do/login.html" method="post" class="form-signin" role="form">
    <h2 class="form-signin-heading">
        <i class="glyphicon glyphicon-log-in"></i> 管理员登录
    </h2>
    <p>${requestScope.exception.message}</p>
```

### 3.5、Controller方法

![image-20210510163152346](C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210510163152346.png)

```java
/**
 *
 * @param loginAccount
 * @param userPswd
 * @param session
 * @return
 */
@RequestMapping("/admin/do/login.html")
public String doLogin(@RequestParam("loginAccount") String loginAccount,
                      @RequestParam("userPswd") String userPswd,
                      HttpSession session) {

    // 调用Service方法执行登录检查
    // 这个方法如果能够返回 admin 对象说明登录成功，如果账号、密码不正确则会抛出异常
    Admin admin = adminService.getAdminByLoginAccount(loginAccount,userPswd);

    // 将登录成功返回的admin对象存入Session域
    session.setAttribute(CrowdConstant.ATTR_NAME_LOGIN_ADMIN,admin);

    return "admin-main";
}
```

### 3.6、Service方法

![image-20210510171203427](C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210510171203427.png)

```java
@Override
public Admin getAdminByLoginAccount(String loginAccount, String userPswd) {

    // 根据登录账号查询Admin对象
    // ①创建 AdminExample 对象
    AdminExample adminExample = new AdminExample();

    // ②创建 Criteria 对象
    AdminExample.Criteria criteria = adminExample.createCriteria();

    // ③在 Criteria 对象中封装查询条件
    criteria.andLoginAcctEqualTo(loginAccount);

    // ④调用 AdminMapper 的方法执行查询
    List<Admin> list = adminMapper.selectByExample(adminExample);

    // 判断 Admin 对象是否为 null
    if (list == null || list.size() == 0) {
        throw new LoginFailedException(CrowdConstant.MESSAGE_LOGIN_FAILED);
    }

    if (list.size() > 1) {
        throw new RuntimeException(CrowdConstant.MESSAGE_SYSTEM_ERROR_LOGIN_NOT_UNIQUE);
    }

    Admin admin = list.get(0);

    // 如果 Admin 对象为 null 则抛出异常
    if (admin == null) {
        throw new LoginFailedException(CrowdConstant.MESSAGE_LOGIN_FAILED);
    }

    // 如果 Admin 对象不为 null 则将数据库密码从 Admin 对象中取出
    String userPswdDB = admin.getUserPswd();

    // 将表单提交的明文密码进行加密
    String userPswdForm = CrowdUtil.md5(userPswd);

    // 对密码进行比较
    if (!Objects.equals(userPswdDB,userPswdForm)) {
        // 如果比较结果是不一致则抛出异
        throw new LoginFailedException(CrowdConstant.MESSAGE_LOGIN_FAILED);
    }

    // 如果一致则返回 Admin 对象
    return admin;
}
```

### 3.7、补充

#### 1、前往后台主页面的方式调整

为了避免跳转到后台主页面再刷新浏览器导致重复提交登录表单，**重定向到目标页面**。

所以 Controller 方法需要做相应修改

![image-20210510181351847](C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210510181351847.png)

```java
/**
 *
 * @param loginAccount  用户账号
 * @param userPswd      用户密码
 * @param session
 * @return
 */
@RequestMapping("/admin/do/login.html")
public String doLogin(@RequestParam("loginAccount") String loginAccount,
                      @RequestParam("userPswd") String userPswd,
                      HttpSession session) {

    // 调用Service方法执行登录检查
    // 这个方法如果能够返回 admin 对象说明登录成功，如果账号、密码不正确则会抛出异常
    Admin admin = adminService.getAdminByLoginAccount(loginAccount,userPswd);

    // 将登录成功返回的admin对象存入Session域
    session.setAttribute(CrowdConstant.ATTR_NAME_LOGIN_ADMIN,admin);

    return "redirect:/admin/to/main/page.html";
}
```

需要给目标地址配置 view-controller

![image-20210510213617580](C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210510213617580.png)

```xml
<mvc:view-controller path="/admin/to/main/page.html" view-name="admin-main"/>
```

#### 2、退出登录

![image-20210510215333513](C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210510215333513.png)

修改超链接

```jsp
<li><a href="admin/do/logout.html"><i class="glyphicon glyphicon-off"></i> 退出系统</a></li>
```

![image-20210510215418304](C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210510215418304.png)

```java
/**
 * 用户退出登录
 * @param session
 * @return
 */
@RequestMapping("/admin/do/logout.html")
public String doLogout(HttpSession session) {

    // 强制session失效
    session.invalidate();

    return "redirect:/admin/to/login/page.html";
}
```

## 4、抽取后台主页公共部分

### 4.1、创建公共部分jsp

![image-20210511082056023](C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210511082056023.png)

#### 1、include-head.jsp

```jsp
<%@ page contentType="text/html;charset=UTF-8" language="java" %>
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">
    <base href="http://${pageContext.request.serverName}:${pageContext.request.serverPort}/">
    <link rel="stylesheet" href="bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="css/font-awesome.min.css">
    <link rel="stylesheet" href="css/main.css">
    <script type="text/javascript" src="jquery/jquery-2.1.1.min.js"></script>
    <script type="text/javascript" src="bootstrap/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="script/docs.min.js"></script>
    <script type="text/javascript" src="layer/layer.js"></script>
    <script type="text/javascript">
        $(function () {
            $(".list-group-item").click(function(){
                if ( $(this).find("ul") ) {
                    $(this).toggleClass("tree-closed");
                    if ( $(this).hasClass("tree-closed") ) {
                        $("ul", this).hide("fast");
                    } else {
                        $("ul", this).show("fast");
                    }
                }
            });
        });
    </script>
    <style>
        .tree li {
            list-style-type: none;
            cursor:pointer;
        }
        .tree-closed {
            height : 40px;
        }
        .tree-expanded {
            height : auto;
        }
    </style>
</head>
```

#### 2、include-nav.jsp

```jsp
<%@ page contentType="text/html;charset=UTF-8" language="java" %>
<nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container-fluid">
        <div class="navbar-header">
            <div><a class="navbar-brand" style="font-size:32px;" href="#">众筹平台 - 控制面板</a></div>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
            <ul class="nav navbar-nav navbar-right">
                <li style="padding-top:8px;">
                    <div class="btn-group">
                        <button type="button" class="btn btn-default btn-success dropdown-toggle" data-toggle="dropdown">
                            <i class="glyphicon glyphicon-user"></i> ${sessionScope.loginAdmin.userName} <span class="caret"></span>
                        </button>
                        <ul class="dropdown-menu" role="menu">
                            <li><a href="#"><i class="glyphicon glyphicon-cog"></i> 个人设置</a></li>
                            <li><a href="#"><i class="glyphicon glyphicon-comment"></i> 消息</a></li>
                            <li class="divider"></li>
                            <li><a href="admin/do/logout.html"><i class="glyphicon glyphicon-off"></i> 退出系统</a></li>
                        </ul>
                    </div>
                </li>
                <li style="margin-left:10px;padding-top:8px;">
                    <button type="button" class="btn btn-default btn-danger">
                        <span class="glyphicon glyphicon-question-sign"></span> 帮助
                    </button>
                </li>
            </ul>
            <form class="navbar-form navbar-right">
                <input type="text" class="form-control" placeholder="查询">
            </form>
        </div>
    </div>
</nav>
```

#### 3、include-sidebar.jsp

```jsp
<%@ page contentType="text/html;charset=UTF-8" language="java" %>
<div class="col-sm-3 col-md-2 sidebar">
    <div class="tree">
        <ul style="padding-left:0px;" class="list-group">
            <li class="list-group-item tree-closed" >
                <a href="main.html"><i class="glyphicon glyphicon-dashboard"></i> 控制面板</a>
            </li>
            <li class="list-group-item tree-closed">
                <span><i class="glyphicon glyphicon glyphicon-tasks"></i> 权限管理 <span class="badge" style="float:right">3</span></span>
                <ul style="margin-top:10px;display:none;">
                    <li style="height:30px;">
                        <a href="user.html"><i class="glyphicon glyphicon-user"></i> 用户维护</a>
                    </li>
                    <li style="height:30px;">
                        <a href="role.html"><i class="glyphicon glyphicon-king"></i> 角色维护</a>
                    </li>
                    <li style="height:30px;">
                        <a href="permission.html"><i class="glyphicon glyphicon-lock"></i> 菜单维护</a>
                    </li>
                </ul>
            </li>
            <li class="list-group-item tree-closed">
                <span><i class="glyphicon glyphicon-ok"></i> 业务审核 <span class="badge" style="float:right">3</span></span>
                <ul style="margin-top:10px;display:none;">
                    <li style="height:30px;">
                        <a href="auth_cert.html"><i class="glyphicon glyphicon-check"></i> 实名认证审核</a>
                    </li>
                    <li style="height:30px;">
                        <a href="auth_adv.html"><i class="glyphicon glyphicon-check"></i> 广告审核</a>
                    </li>
                    <li style="height:30px;">
                        <a href="auth_project.html"><i class="glyphicon glyphicon-check"></i> 项目审核</a>
                    </li>
                </ul>
            </li>
            <li class="list-group-item tree-closed">
                <span><i class="glyphicon glyphicon-th-large"></i> 业务管理 <span class="badge" style="float:right">7</span></span>
                <ul style="margin-top:10px;display:none;">
                    <li style="height:30px;">
                        <a href="cert.html"><i class="glyphicon glyphicon-picture"></i> 资质维护</a>
                    </li>
                    <li style="height:30px;">
                        <a href="type.html"><i class="glyphicon glyphicon-equalizer"></i> 分类管理</a>
                    </li>
                    <li style="height:30px;">
                        <a href="process.html"><i class="glyphicon glyphicon-random"></i> 流程管理</a>
                    </li>
                    <li style="height:30px;">
                        <a href="advertisement.html"><i class="glyphicon glyphicon-hdd"></i> 广告管理</a>
                    </li>
                    <li style="height:30px;">
                        <a href="message.html"><i class="glyphicon glyphicon-comment"></i> 消息模板</a>
                    </li>
                    <li style="height:30px;">
                        <a href="project_type.html"><i class="glyphicon glyphicon-list"></i> 项目分类</a>
                    </li>
                    <li style="height:30px;">
                        <a href="tag.html"><i class="glyphicon glyphicon-tags"></i> 项目标签</a>
                    </li>
                </ul>
            </li>
            <li class="list-group-item tree-closed" >
                <a href="param.html"><i class="glyphicon glyphicon-list-alt"></i> 参数管理</a>
            </li>
        </ul>
    </div>
</div>
```

### 4.2、抽取后的效果

```jsp
<%@ page contentType="text/html;charset=UTF-8" language="java" %>
<!DOCTYPE html>
<html lang="zh-CN">
<%@include file="include-head.jsp"%>

<body>

<%@include file="include-nav.jsp"%>
<div class="container-fluid">
    <div class="row">
        <%@include file="include-sidebar.jsp"%>
        <div class="col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main">
            <h1 class="page-header">控制面板</h1>

            <div class="row placeholders">
                
                ......
                
            </div>
        </div>
    </div>
</div>

</body>
</html>
```

### 4.3、创建jsp模板

模板内容

```jsp
<%@ page contentType="text/html;charset=UTF-8" language="java" %>
<!DOCTYPE html>
<html lang="zh-CN">
<%@include file="include-head.jsp"%>

<body>

<%@include file="include-nav.jsp"%>
<div class="container-fluid">
    <div class="row">
        <%@include file="include-sidebar.jsp"%>
        <div class="col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main">
            
        </div>
    </div>
</div>

</body>
</html>
```

![image-20210511082615127](C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210511082615127.png)



## 5、登录状态检查

### 5.1、目标

将部分资源保护起来，让没有登录的请求不能访问。

### 5.2、思路

![image-20210511083003399](C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210511083003399.png)

### 5.3、代码

#### 1、创建自定义异常

![image-20210511083947852](C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210511083947852.png)

```java
package com.atguigu.crowd.exception;

/**
 * 表示用户没有登录就访问受保护资源时抛出的异常
 * @author zhulei
 * @create 2021-05-11 8:37
 */
public class AccessForbiddenException extends RuntimeException{

    private static final long serialVersionUID = 1L;

    public AccessForbiddenException() {
        super();
    }

    public AccessForbiddenException(String message) {
        super(message);
    }

    public AccessForbiddenException(String message, Throwable cause) {
        super(message, cause);
    }

    public AccessForbiddenException(Throwable cause) {
        super(cause);
    }

    protected AccessForbiddenException(String message, Throwable cause, boolean enableSuppression, boolean writableStackTrace) {
        super(message, cause, enableSuppression, writableStackTrace);
    }
}
```

#### 2、创建拦截器类

![image-20210511084059755](C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210511084059755.png)

```java
public class LoginInterceptor extends HandlerInterceptorAdapter {

    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {

        // 通过request对象获取Session对象
        HttpSession session = request.getSession();

        // 尝试从session域中获取Admin对象
        Admin admin = (Admin) session.getAttribute(CrowdConstant.ATTR_NAME_LOGIN_ADMIN);

        // 判断admin是否为空
        if (admin == null) {

            // 抛出异常
            throw new AccessForbiddenException(CrowdConstant.MESSAGE_ACCESS_FORBIDDEN);

        }

        // 如果admin对象不为空，则返回true放行
        return true;
    }
}
```

#### 3、注册拦截器类

![image-20210511090801291](C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210511090801291.png)

```xml
<!--注册拦截器-->
<mvc:interceptors>
    <mvc:interceptor>
        <!--要拦截的资源-->
        <!-- /*对应一层路径，比如：/aaa -->
        <!-- /**对应多层路径，比如：/aaa/bbb 或/aaa/bbb/ccc 或/aaa/bbb/ccc/ddd -->
        <mvc:mapping path="/**"/>
        <!--不拦截的资源-->
        <mvc:exclude-mapping path="/admin/to/login/page.html"/>
        <mvc:exclude-mapping path="/admin/do/login.html"/>
        <mvc:exclude-mapping path="/admin/do/logout.html"/>
        <bean class="com.atguigu.crowd.mvc.interceptor.LoginInterceptor"/>
    </mvc:interceptor>
</mvc:interceptors>
```

### 5.4、完善配套的异常映射

1、基于xml的异常映射

![image-20210511090801291](C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210511090801291.png)

![image-20210511091054732](C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210511091054732.png)

2、基于注解的异常映射

![image-20210511091158049](C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210511091158049.png)

```java
@ExceptionHandler(value = AccessForbiddenException.class)
public ModelAndView resolveAccessForbiddenException(AccessForbiddenException exception,
                                                HttpServletRequest request,
                                                HttpServletResponse response) throws IOException {
    // 登录失败回到登录页面
    String viewName = "admin-login";
    // 返回ModelAndView对象
    return commonResolve(viewName,exception,request,response);
}
```



# 管理员维护

## 1、任务

- 分页显示 Admin 数据
  - 不带关键词分页
  - 带关键词分页
- 新增 Admin
- 更新 Admin
- 单条删除 Admin

## 2、分页

### 2.1、目标

将数据库中的 Admin 数据在页面上以分页形式显示。在后端将“带关键词”和“不带关键词”的分页合并为同一套代码。

### 2.2、思路

![image-20210511093025414](C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210511093025414.png)

### 2.3、代码

#### 2.3.1、引入pageHelper

https://github.com/pagehelper/Mybatis-PageHelper/blob/master/wikis/zh/HowToUse.md

- 确认是否导入依赖

```xml
<!-- MyBatis 分页插件 -->
<dependency>
    <groupId>com.github.pagehelper</groupId>
    <artifactId>pagehelper</artifactId>
    <version>4.0.0</version>
</dependency>
```

- 在SqlSessionFactoryBean配置MyBatis插件

![image-20210511093453271](C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210511093453271.png)

```xml
<!--配置SqlSessionFactoryBean整合MyBatis-->
<bean id="sqlSessionFactoryBean" class="org.mybatis.spring.SqlSessionFactoryBean">
    <!-- 指定 MyBatis 全局配置文件位置 -->
    <property name="configLocation" value="classpath:mybatis-config.xml"/>
    <!-- 指定 Mapper.xml 配置文件位置 -->
    <property name="mapperLocations" value="classpath:mybatis/mapper/*Mapper.xml"/>
    <!-- 装配数据源 -->
    <property name="dataSource" ref="dataSource"/>
    <!--配置插件-->
    <property name="plugins">
        <array>
            <!--配置PageHelper插件-->
            <bean class="com.github.pagehelper.PageHelper">
                <property name="properties">
                    <props>
                        <!--配置数据库方言，告诉PageHelper当前使用的数据库-->
                        <prop key="dialect">mysql</prop>
                        <!--
                            reasonable：分页合理化参数，默认值为false。
                            当该参数设置为 true 时，pageNum<=0 时会查询第一页， pageNum>pages（超过总数时），会查询最后一页。
                            默认false 时，直接根据参数进行查询。
                        -->
                        <prop key="reasonable">true</prop>
                    </props>
                </property>
            </bean>
        </array>
    </property>
</bean>
```

#### 2.3.2、在AdminMapper中编写SQL语句

![image-20210511101142599](C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210511101142599.png)

```xml
<select id="selectAdminByKeyword" resultMap="BaseResultMap">
  select id, login_acct, user_pswd, user_name, email, create_time
  from t_admin
  where login_acct like concat("%",#{keyword},"%")
     or user_name like concat("%",#{keyword},"%")
     or email like concat("%",#{keyword},"%")
</select>
```

#### 2.3.3、AdminMapper接口中声明方法

![image-20210511102033611](C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210511102033611.png)

```java
List<Admin> selectAdminByKeyword(String keyword);
```

#### 2.3.4、AdminService方法

![image-20210511103111268](C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210511103111268.png)

```java
/**
 * 获得分页查询结果
 * @param keyword   模糊查询关键词
 * @param pageNum   页码
 * @param pageSize  每页显示数量
 * @return
 */
@Override
public PageInfo<Admin> getPageInfo(String keyword, Integer pageNum, Integer pageSize) {

    // 调用PageHelper的静态方法开启分页
    PageHelper.startPage(pageNum,pageSize);

    // 执行查询
    List<Admin> adminList = adminMapper.selectAdminByKeyword(keyword);

    // 封装到PageInfo对象中
    return new PageInfo<>(adminList);
}
```

#### 2.3.5、AdminController方法

```java
/**
 *
 * @param keyword   模糊查询关键字，在请求中没有携带对应参数时使用默认值
 *                  默认值为 "" ，和sql语句配合实现两种情况的适配
 * @param pageNum   页码，默认去第一页
 * @param pageSize  每页显示数量，默认为5条
 * @param modelMap
 * @return
 */
@RequestMapping("/admin/get/page.html")
public String getPageInfo(@RequestParam(value = "keyword",defaultValue = "") String keyword,
                          @RequestParam(value = "pageNum",defaultValue = "1") Integer pageNum,
                          @RequestParam(value = "pageSize",defaultValue = "5") Integer pageSize,
                          ModelMap modelMap) {

    // 调用Service方法获取PageInfo对象
    PageInfo<Admin> pageInfo = adminService.getPageInfo(keyword, pageNum, pageSize);

    // 将pageInfo对象存入模型
    modelMap.addAttribute(CrowdConstant.ATTR_NAME_PAGE_INFO,pageInfo);

    return "admin-page";
}
```

#### 2.3.6、页面显示主体

![image-20210511135051670](C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210511135051670.png)

#### 2.3.7、在页面上使用Pagination实现页码导航条

1、导入Pagination环境

![image-20210511135542259](C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210511135542259.png)

在有需要的页面上引入：注意先后顺序，Pagination要在jQuery后面

```jsp
<%@include file="include-head.jsp" %>
<link rel="stylesheet" href="css/pagination.css" />
<script type="text/javascript" src="jquery/jquery.pagination.js"></script>
```

2、HTML代码所需准备

使用Pagination要求的页码标签替换原有的页码部分

```jsp
<ul class="pagination">
    <li class="disabled"><a href="#">上一页</a></li>
    <li class="active"><a href="#">1 <span class="sr-only">(current)</span></a></li>
    <li><a href="#">2</a></li>
    <li><a href="#">3</a></li>
    <li><a href="#">4</a></li>
    <li><a href="#">5</a></li>
    <li><a href="#">下一页</a></li>
</ul>
```

替换为

```jsp
<div id="Pagination" class="pagination"><!-- 这里显示分页 --></div>
```

3、jQuery代码

```javascript
<script type="text/javascript">

    $(function () {

        // 对页码导航条进行初始化
        initPagination();

    });

    // 生成页码导航条的函数
    function initPagination() {

        // 获取总记录数
        var totalRecord = ${requestScope.pageInfo.total};

        // 声明 Pagination 设置属性的 JSON 对象
        var properties = {
            num_edge_entries: 3, // 边缘页数
            num_display_entries: 5, // 主体页数
            callback: pageSelectCallback, // 用户点击“翻页”按钮之后执行翻页操作的回调函数
            current_page: ${requestScope.pageInfo.pageNum-1}, // 当前页，pageNum 从 1 开始，必须-1 后才可以赋值
            prev_text: "上一页",
            next_text: "下一页",
            items_per_page:${requestScope.pageInfo.pageSize} // 每页显示 1 项
        };

        // 生成页码导航条
        $("#Pagination").pagination(totalRecord,properties)
    }

    // 回调函数：声明出来以后不是自己调用，而是交个系统或框架调用
    // 用户点击 1,2,3 这样的页码时调用这个函数实现页面跳转
    function pageSelectCallback(pageIndex,jQuery) {

        // 根据pageIndex计算得到pageNum
        var pageNum = pageIndex + 1;

        // 跳转页面
        window.location.href = "admin/get/page.html?pageNum=" + pageNum;

        // 由于每一个页码按钮都是超链接，所以在这个函数最后取消超链接的默认行为
        return false;

    };

</script>
```

4、修改Pagination 源码

原因：

![image-20210511151422600](C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210511151422600.png)

问题的解决：不让 Pagination 在页码导航条初始化完成时就调用回调函数！

![image-20210511153929120](C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210511153929120.png)

![image-20210511154012469](C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210511154012469.png)

## 3、关键词查询

### 3.1、页面上调整查询表单

![image-20210511154256761](C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210511154256761.png)

![image-20210511154614565](C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210511154614565.png)

```jsp
<form action="/admin/get/page.html" method="post" class="form-inline" role="form" style="float:left;">
    <div class="form-group has-feedback">
        <div class="input-group">
            <div class="input-group-addon">查询条件</div>
            <input name="keyword" class="form-control has-success" type="text" placeholder="请输入查询条件">
        </div>
    </div>
    <button type="submit" class="btn btn-warning"><i class="glyphicon glyphicon-search"></i> 查询</button>
</form>
```

### 3.2、翻页时保持查询条件关键词

![image-20210511155225765](C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210511155225765.png)

```javascript
// 回调函数：声明出来以后不是自己调用，而是交个系统或框架调用
// 用户点击 1,2,3 这样的页码时调用这个函数实现页面跳转
function pageSelectCallback(pageIndex,jQuery) {

    // 根据pageIndex计算得到pageNum
    var pageNum = pageIndex + 1;

    // 跳转页面
    window.location.href = "admin/get/page.html?pageNum=" + pageNum + "&keyword=${param.keyword}";

    // 由于每一个页码按钮都是超链接，所以在这个函数最后取消超链接的默认行为
    return false;

};
```

## 4、单条删除

### 4.1、目标

在页面上点击单条删除按钮，实现Admin对应记录的删除

### 4.2、思路

![image-20210511155848733](C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210511155848733.png)

### 4.3、代码

#### 4.3.1、调整删除的按钮

![image-20210511154256761](file://C:/Users/%E6%9C%B1%E7%A3%8A/AppData/Roaming/Typora/typora-user-images/image-20210511154256761.png?lastModify=1620693966)

**旧代码**

```jsp
<button type="button" class="btn btn-danger btn-xs">
    <i class=" glyphicon glyphicon-remove"></i>
</button>
```

**新代码**

```jsp
<a href="admin/remove/${admin.id}/${requestScope.pageInfo.pageNum}/${param.keyword}.html" class="btn btn-danger btn-xs">
    <i class=" glyphicon glyphicon-remove"></i>
</a>
```

#### 4.3.2、AdminController.removeAdmin()

![image-20210511161127642](C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210511161127642.png)

```java
/**
 * 删除单个用户
 * @param adminId 待删除用户的id
 * @return
 */
@RequestMapping("/admin/remove/{adminId}/{pageNum}/{keyword}.html")
public String removeAdmin(@PathVariable("adminId") Integer adminId,
                          @PathVariable("pageNum") Integer pageNum,
                          @PathVariable("keyword") String keyword) {

    // 执行删除
    adminService.removeAdmin(adminId);

    // 页面跳转：回到分页页面
    // 1、直接转发到admin-page.jsp会无法显示分页数据
    // return "admin-page";

    // 2、转发到/admin/get/page.html地址，一旦刷新页面会重复执行删除，浪费性能
    // return "forward:/admin/get/page.html";

    // 3、重定向到/admin/get/page.html，同时为了保持所在的页面和查询的关键词，再附加pageNum和keyword两个请求参数
    return "redirect:/admin/get/page.html?pageNum=" + pageNum + "&keyword=" + keyword;
}
```

#### 4.3.3、AdminService.removeAdmin()

![image-20210511165033862](C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210511165033862.png)

```java
@Override
public void removeAdmin(Integer adminId) {
    adminMapper.deleteByPrimaryKey(adminId);
}
```

## 5、新增

#### 5.1、目标

将表单提交的Admin对象提交到数据库中。

- loginAcct 不能重复
- 密码加密

#### 5.2、思路

<img src="C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210511201636292.png" alt="image-20210511201636292" style="zoom:80%;" />

#### 5.3、在t_admin表中给账号添加唯一约束

```sql
ALTER TABLE `project_crowd`.`t_admin` ADD UNIQUE INDEX (`login_acct`); 
```

#### 5.4、调整新增按钮

![image-20210511202623775](C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210511202623775.png)

```jsp
<%旧代码%>
<%--
    <button type="button" class="btn btn-primary" style="float:right;" onclick="window.location.href='add.html'">
    	<i class="glyphicon glyphicon-plus"></i> 新增
    </button>
--%>
<%新代码%>
<a href="admin/to/add/page.html" class="btn btn-primary" style="float:right;">
    <i class="glyphicon glyphicon-plus"></i> 新增
</a>
```

#### 5.5、配置view-controller

![image-20210511203231120](C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210511203231120.png)

```xml
<mvc:view-controller path="/admin/to/add/page.html" view-name="admin-add"/>
```

#### 5.5、准备表单页面

![image-20210511203553675](C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210511203553675.png)

#### 5.6、Controller方法

![image-20210511202505956](C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210511202505956.png)

```java
@RequestMapping("/admin/save.html")
public String saveAdmin(Admin admin) {

    // 保存
    adminService.saveAdmin(admin);

    // 重定向到显示列表最后一页
    return "redirect:/admin/get/page.html?pageNum=" + Integer.MAX_VALUE;
}
```

#### 5.7、Service方法

![image-20210511210441585](C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210511210441585.png)

```java
@Override
public void saveAdmin(Admin admin) {

    // 密码加密
    String userPswd = CrowdUtil.md5(admin.getUserPswd());
    admin.setUserPswd(userPswd);

    // 生成创建时间
    Date date = new Date();
    SimpleDateFormat format = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss");
    String createTime = format.format(date);
    admin.setCreateTime(createTime);

    // 保存用户
    try {
        adminMapper.insert(admin);
    } catch (Exception e) {
        e.printStackTrace();
        logger.info("异常全类名" + e.getClass().getName());
        if (e instanceof DuplicateKeyException) {
            throw new LoginAcctAlreadyInUseException(CrowdConstant.MESSAGE_LOGIN_ACCT_ALREADY_USED);
        }
    }
}
```

配置异常类

![image-20210511212604450](C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210511212604450.png)

将异常类配置到异常处理中

![image-20210511212640067](C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210511212640067.png)

```java
@ExceptionHandler(value = LoginAcctAlreadyInUseException.class)
public ModelAndView resolveLoginAcctAlreadyInUseException(LoginAcctAlreadyInUseException exception,
                                                    HttpServletRequest request,
                                                    HttpServletResponse response) throws IOException {
    // 回到用户添加页面
    String viewName = "admin-add";
    // 返回ModelAndView对象
    return commonResolve(viewName,exception,request,response);
}
```



## 6、更新

### 6.1、目标

修改现有Admin数据，不修改密码，不修改创建时间

### 6.2、思路

![image-20210511213134790](C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210511213134790.png)

### 6.3、代码：回显表单

#### 1、调整修改按钮

![image-20210513083159391](C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210513083159391.png)

```jsp
<a href="admin/to/edit/page.html?adminId=${admin.id}?pageNum=${requestScope.pageInfo.pageNum}&keyword=${param.keyword}" class="btn btn-primary btn-xs">
    <i class=" glyphicon glyphicon-pencil"></i>
</a>
```

#### 2、Controller方法

![image-20210511202505956](file://C:/Users/%E6%9C%B1%E7%A3%8A/AppData/Roaming/Typora/typora-user-images/image-20210511202505956.png?lastModify=1620693966)

```java
/**
 * 前往修改页面
 * @param adminId   待修改用户的id
 * @param modelMap  模型
 * @return
 */
@RequestMapping("/admin/to/edit/page.html")
public String toEditPage(@RequestParam("adminId") Integer adminId,
                         ModelMap modelMap) {

    // 根据adminId查询Admin对象
    Admin admin = adminService.getAdminById(adminId);

    // 将admin对象存入模型
    modelMap.addAttribute("admin",admin);

    return "admin-edit";
}
```

#### 3、Service方法

```java
@Override
public Admin getAdminById(Integer adminId) {

    return adminMapper.selectByPrimaryKey(adminId);

}
```

#### 4、整理表单页面

```jsp
<%@ page contentType="text/html;charset=UTF-8" language="java" %>
<!DOCTYPE html>
<html lang="zh-CN">
<%@include file="include-head.jsp" %>

<body>

<%@include file="include-nav.jsp" %>
<div class="container-fluid">
    <div class="row">
        <%@include file="include-sidebar.jsp" %>
        <div class="col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main">
            <ol class="breadcrumb">
                <li><a href="/admin/to/main/page.html">首页</a></li>
                <li><a href="/admin/get/page.html">数据列表</a></li>
                <li class="active">更新</li>
            </ol>
            <div class="panel panel-default">
                <div class="panel-heading">表单数据<div style="float:right;cursor:pointer;" data-toggle="modal" data-target="#myModal"><i class="glyphicon glyphicon-question-sign"></i></div></div>
                <div class="panel-body">
                    <form action="admin/update.html" method="post" role="form">
                        <input type="hidden" name="id" value="${requestScope.admin.id}">
                        <input type="hidden" name="pageNum" value="${param.pageNum}">
                        <input type="hidden" name="keyword" value="${param.keyword}">
                        <p>${requestScope.exception.message}</p>
                        <div class="form-group">
                            <label for="exampleInputPassword1">登录账号</label>
                            <input name="loginAcct"
                                   value="${requestScope.admin.loginAcct}"
                                   type="text" class="form-control" id="exampleInputPassword1" placeholder="请输入登录账号">
                        </div>
                        <div class="form-group">
                            <label for="exampleInputPassword1">用户昵称</label>
                            <input name="userName"
                                   value="${requestScope.admin.userName}"
                                   type="text" class="form-control" id="exampleInputPassword1" placeholder="请输入用户昵称">
                        </div>
                        <div class="form-group">
                            <label for="exampleInputEmail1">邮箱地址</label>
                            <input name="email"
                                   value="${requestScope.admin.email}"
                                   type="email" class="form-control" id="exampleInputEmail1" placeholder="请输入邮箱地址">
                            <p class="help-block label label-warning">请输入合法的邮箱地址, 格式为： xxxx@xxxx.com</p>
                        </div>
                        <button type="submit" class="btn btn-success"><i class="glyphicon glyphicon-edit"></i> 更新</button>
                        <button type="reset" class="btn btn-danger"><i class="glyphicon glyphicon-refresh"></i> 重置</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

</body>
</html>
```

### 6.4、代码：执行更新

#### 1、Controller方法

```java
@RequestMapping("/admin/update.html")
public String updateAdmin(Admin admin,
                          @RequestParam("pageNum") Integer pageNum,
                          @RequestParam("keyword") String keyword) {

    adminService.updateAdmin(admin);

    return "redirect:/admin/get/page.html?pageNum=" + pageNum + "&keyword=" + keyword;
}
```

#### 2、Service方法

```java
@Override
public void updateAdmin(Admin admin) {

    // 表示有选择的更新，对于null值得字段不更新
    try {
        adminMapper.updateByPrimaryKeySelective(admin);
    } catch (Exception e) {
        if (e instanceof DuplicateKeyException) {
            e.printStackTrace();
            throw new LoginAcctAlreadyInUseForUpdateException(CrowdConstant.MESSAGE_LOGIN_ACCT_ALREADY_USED);
        }
    }
}
```

#### 3、声明LoginAcctAlreadyInUseForUpdateException异常类

说明：之所以要新建一个异常类，是为了在出现问题时（账号重复）不要跳转到Admin新增页面。

![image-20210513083921031](C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210513083921031.png)

```java
package com.atguigu.crowd.exception;

/**
 * 保存或更新Admin时，检测到登录账号重复抛出这个异常
 * @author zhulei
 * @create 2021-05-11 21:17
 */
public class LoginAcctAlreadyInUseForUpdateException extends RuntimeException {

    static final long serialVersionUID = 1L;

    public LoginAcctAlreadyInUseForUpdateException() {
        super();
    }

    public LoginAcctAlreadyInUseForUpdateException(String message) {
        super(message);
    }

    public LoginAcctAlreadyInUseForUpdateException(String message, Throwable cause) {
        super(message, cause);
    }

    public LoginAcctAlreadyInUseForUpdateException(Throwable cause) {
        super(cause);
    }

    protected LoginAcctAlreadyInUseForUpdateException(String message, Throwable cause, boolean enableSuppression, boolean writableStackTrace) {
        super(message, cause, enableSuppression, writableStackTrace);
    }
}
```

#### 4、在异常处理类中声明对应的处理方法

![image-20210513090118637](C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210513090118637.png)

```java
@ExceptionHandler(value = LoginAcctAlreadyInUseForUpdateException.class)
public ModelAndView resolveLoginAcctAlreadyInUseForUpdateException(LoginAcctAlreadyInUseForUpdateException exception,
                                                          HttpServletRequest request,
                                                          HttpServletResponse response) throws IOException {
    // 跳转到系统错误页面
    String viewName = "system-error";
    // 返回ModelAndView对象
    return commonResolve(viewName,exception,request,response);
}
```

说明：不回到更新的表单页面是因为没有携带能够回显的表单数据。

# RBAC权限控制模型

## 1.简介

### 1.1、为什么要进行权限控制

如果没有权限控制，系统的功能完全不设防，全部暴露在所有用户面前。用户登录 以后可以使用系统中的所有功能。这是实际运行中不能接受的。 

所以权限控制系统的目标就是管理用户行为，保护系统功能。

### 1.2、什么是权限控制

“权限”=“权力”+“限制”

### 1.3、如何进行权限控制

1. **定义资源**

   资源就是系统中需要保护起来的功能。具体形式很多：URL 地址、handler 方 法、service 方法、页面元素等等都可以定义为资源使用权限控制系统保护起来。

2. **创建权限**

   一个功能复杂的项目会包含很多具体资源，成千上万都有可能。这么多资源逐 个进行操作太麻烦了。为了简化操作，可以将相关的几个资源封装到一起，打包成 一个“权限”同时分配给有需要的人。

   ![image-20210513092410342](C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210513092410342.png)![image-20210513092420366](C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210513092420366.png)

3. **创建角色**

   对于一个庞大系统来说，一方面需要保护的资源非常多，另一方面操作系统的 人也非常多。把资源打包为权限是对操作的简化，同样把用户划分为不同角色也是 对操作的简化。否则直接针对一个个用户进行管理就会很繁琐。 

   所以角色就是用户的分组、分类。先给角色分配权限，然后再把角色分配给用 户，用户以这个角色的身份操作系统就享有角色对应的权限了。

4. **管理用户**

   系统中的用户其实是人操作系统时用来登录系统的账号、密码。

5. **建立关联关系**

   - 权限→资源：单向多对多
     - Java 类之间单向：从权限实体类可以获取到资源对象的集合，但是通过资 源获取不到权限
     - 数据库表之间多对多
       - 一个权限可以包含多个资源
       - 一个资源可以被分配给多个不同权限
   - 角色→权限：单向多对多
     - Java 类之间单向：从角色实体类可以获取到权限对象的集合，但是通过权 限获取不到角色
     - 数据库表之间多对多：
       - 一个角色可以包含多个权限
       - 一个权限可以被分配给多个不同角色
   - 用户→角色：双向多对多
     - Java 类之间双向：可以通过用户获取它具备的角色，也可以看一个角色下 包含哪些用户
     - 数据库表之间：
       - 一个角色可以包含多个用户
       - 一个用户可以身兼数职

## 2、多对多关联关系在数据库中的表示

### 2.1、没有中间表的情况

![image-20210513100006187](C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210513100006187.png)

如果只能在一个外键列上存储关联关系数据，那么现在这个情况无法使用 SQL 语句 进行关联查询。

### 2.2、有中间表

![image-20210513100041640](C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210513100041640.png)

select t_studet.id,t_student.name from t_student left join t_inner on t_studen.id=t_inner.stuent_id left join t_subject on t_inner.subject_id=t_subject.id where t_subjct.id=1

### 2.3、中间表的主键生成方式

1、方式一：另外设置字段作为主键

![image-20210513100324326](C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210513100324326.png)

2、方式二：使用联合主键

![image-20210513100342975](C:\Users\朱磊\AppData\Roaming\Typora\typora-user-images\image-20210513100342975.png)

组合起来不能重复即可

